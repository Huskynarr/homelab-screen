/*
 * SPDX-License-Identifier: GPL-3.0-only
 * Copyright (C) 2026 homelab-screen contributors
 */

#include "trlcd.h"

/* Modern dark theme - RGB565 */
#define COLOR_BG        0x0000  /* Pure black */
#define COLOR_BG_CARD   0x10A2  /* #202020 neutral dark */
#define COLOR_BG_GAUGE  0x0841  /* #080808 very dark */
#define COLOR_WHITE     0xFFFF  /* Pure white */
#define COLOR_GRAY      0xB596  /* #B0B0B0 light gray */
#define COLOR_DARK_GRAY 0x630C  /* #606060 medium gray */
#define COLOR_PRIMARY   0x2D7F  /* #28B0FF nice blue */
#define COLOR_BLUE      0x2D7F  /* Same blue */
#define COLOR_CYAN      0x2D7F  /* Same blue */
#define COLOR_GREEN     0x2EC8  /* #30D840 modern green */
#define COLOR_ORANGE    0xFC00  /* #FF8000 amber */
#define COLOR_RED       0xF800  /* #FF0000 red */
#define COLOR_YELLOW    0xFE00  /* #FFD000 */
#define COLOR_TEAL      0x2E8E  /* #28D0B0 teal */

/* Built-in 8x16 font (extended for large display) */
static const uint8_t font8x16[][16] = {
    /* Space 0x20 */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* ! */
    {0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* " */
    {0x00,0x63,0x63,0x63,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* # */
    {0x00,0x00,0x00,0x36,0x36,0x7F,0x36,0x36,0x36,0x7F,0x36,0x36,0x00,0x00,0x00,0x00},
    /* $ */
    {0x0C,0x0C,0x3E,0x63,0x61,0x60,0x3E,0x03,0x03,0x43,0x63,0x3E,0x0C,0x0C,0x00,0x00},
    /* % */
    {0x00,0x00,0x00,0x00,0x00,0x61,0x63,0x06,0x0C,0x18,0x33,0x63,0x00,0x00,0x00,0x00},
    /* & */
    {0x00,0x00,0x00,0x1C,0x36,0x36,0x1C,0x3B,0x6E,0x66,0x66,0x3B,0x00,0x00,0x00,0x00},
    /* ' */
    {0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* ( */
    {0x00,0x00,0x0C,0x18,0x18,0x30,0x30,0x30,0x30,0x18,0x18,0x0C,0x00,0x00,0x00,0x00},
    /* ) */
    {0x00,0x00,0x18,0x0C,0x0C,0x06,0x06,0x06,0x06,0x0C,0x0C,0x18,0x00,0x00,0x00,0x00},
    /* * */
    {0x00,0x00,0x00,0x00,0x42,0x66,0x3C,0xFF,0x3C,0x66,0x42,0x00,0x00,0x00,0x00,0x00},
    /* + */
    {0x00,0x00,0x00,0x00,0x18,0x18,0x18,0xFF,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    /* , */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00},
    /* - */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* . */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* / */
    {0x00,0x00,0x01,0x03,0x07,0x0E,0x1C,0x38,0x70,0xE0,0xC0,0x80,0x00,0x00,0x00,0x00},
    /* 0 */
    {0x00,0x00,0x3E,0x63,0x63,0x67,0x6F,0x7B,0x73,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 1 */
    {0x00,0x00,0x0C,0x1C,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3F,0x00,0x00,0x00,0x00},
    /* 2 */
    {0x00,0x00,0x3E,0x63,0x03,0x06,0x0C,0x18,0x30,0x60,0x63,0x7F,0x00,0x00,0x00,0x00},
    /* 3 */
    {0x00,0x00,0x3E,0x63,0x03,0x03,0x1E,0x03,0x03,0x03,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 4 */
    {0x00,0x00,0x06,0x0E,0x1E,0x36,0x66,0x66,0x7F,0x06,0x06,0x0F,0x00,0x00,0x00,0x00},
    /* 5 */
    {0x00,0x00,0x7F,0x60,0x60,0x60,0x7E,0x03,0x03,0x63,0x73,0x3E,0x00,0x00,0x00,0x00},
    /* 6 */
    {0x00,0x00,0x1C,0x30,0x60,0x60,0x7E,0x63,0x63,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 7 */
    {0x00,0x00,0x7F,0x63,0x03,0x06,0x06,0x0C,0x0C,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 8 */
    {0x00,0x00,0x3E,0x63,0x63,0x63,0x3E,0x63,0x63,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 9 */
    {0x00,0x00,0x3E,0x63,0x63,0x63,0x63,0x3F,0x03,0x03,0x06,0x3C,0x00,0x00,0x00,0x00},
    /* : */
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    /* ; */
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00},
    /* < */
    {0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
    /* = */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00},
    /* > */
    {0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00},
    /* ? */
    {0x00,0x00,0x3E,0x63,0x63,0x06,0x0C,0x0C,0x0C,0x00,0x0C,0x0C,0x00,0x00,0x00,0x00},
    /* @ */
    {0x00,0x00,0x3E,0x63,0x63,0x6F,0x6B,0x6B,0x6E,0x60,0x60,0x3E,0x00,0x00,0x00,0x00},
    /* A */
    {0x00,0x00,0x08,0x1C,0x36,0x63,0x63,0x7F,0x63,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    /* B */
    {0x00,0x00,0x7E,0x33,0x33,0x33,0x3E,0x33,0x33,0x33,0x33,0x7E,0x00,0x00,0x00,0x00},
    /* C */
    {0x00,0x00,0x1E,0x33,0x61,0x60,0x60,0x60,0x60,0x61,0x33,0x1E,0x00,0x00,0x00,0x00},
    /* D */
    {0x00,0x00,0x7C,0x36,0x33,0x33,0x33,0x33,0x33,0x33,0x36,0x7C,0x00,0x00,0x00,0x00},
    /* E */
    {0x00,0x00,0x7F,0x33,0x31,0x34,0x3C,0x34,0x30,0x31,0x33,0x7F,0x00,0x00,0x00,0x00},
    /* F */
    {0x00,0x00,0x7F,0x33,0x31,0x34,0x3C,0x34,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00},
    /* G */
    {0x00,0x00,0x1E,0x33,0x61,0x60,0x60,0x6F,0x63,0x63,0x37,0x1D,0x00,0x00,0x00,0x00},
    /* H */
    {0x00,0x00,0x63,0x63,0x63,0x63,0x7F,0x63,0x63,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    /* I */
    {0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* J */
    {0x00,0x00,0x0F,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00,0x00,0x00,0x00},
    /* K */
    {0x00,0x00,0x73,0x33,0x36,0x36,0x3C,0x36,0x36,0x33,0x33,0x73,0x00,0x00,0x00,0x00},
    /* L */
    {0x00,0x00,0x78,0x30,0x30,0x30,0x30,0x30,0x30,0x31,0x33,0x7F,0x00,0x00,0x00,0x00},
    /* M */
    {0x00,0x00,0x63,0x77,0x7F,0x7F,0x6B,0x63,0x63,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    /* N */
    {0x00,0x00,0x63,0x63,0x73,0x7B,0x7F,0x6F,0x67,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    /* O */
    {0x00,0x00,0x3E,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* P */
    {0x00,0x00,0x7E,0x33,0x33,0x33,0x3E,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00},
    /* Q */
    {0x00,0x00,0x3E,0x63,0x63,0x63,0x63,0x63,0x63,0x6B,0x6F,0x3E,0x06,0x07,0x00,0x00},
    /* R */
    {0x00,0x00,0x7E,0x33,0x33,0x33,0x3E,0x36,0x36,0x33,0x33,0x73,0x00,0x00,0x00,0x00},
    /* S */
    {0x00,0x00,0x3E,0x63,0x63,0x30,0x1C,0x06,0x03,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* T */
    {0x00,0x00,0xFF,0xDB,0x99,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* U */
    {0x00,0x00,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* V */
    {0x00,0x00,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x36,0x1C,0x08,0x00,0x00,0x00,0x00},
    /* W */
    {0x00,0x00,0x63,0x63,0x63,0x63,0x63,0x6B,0x6B,0x7F,0x36,0x36,0x00,0x00,0x00,0x00},
    /* X */
    {0x00,0x00,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x3C,0x66,0xC3,0xC3,0x00,0x00,0x00,0x00},
    /* Y */
    {0x00,0x00,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* Z */
    {0x00,0x00,0x7F,0x63,0x43,0x06,0x0C,0x18,0x30,0x61,0x63,0x7F,0x00,0x00,0x00,0x00},
    /* [ */
    {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
    /* \ */
    {0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x07,0x03,0x01,0x00,0x00,0x00,0x00},
    /* ] */
    {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
    /* ^ */
    {0x08,0x1C,0x36,0x63,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* _ */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00},
    /* ` */
    {0x18,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* a */
    {0x00,0x00,0x00,0x00,0x00,0x3C,0x46,0x06,0x3E,0x66,0x66,0x3B,0x00,0x00,0x00,0x00},
    /* b */
    {0x00,0x00,0x70,0x30,0x30,0x3C,0x36,0x33,0x33,0x33,0x33,0x6E,0x00,0x00,0x00,0x00},
    /* c */
    {0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x60,0x60,0x60,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* d */
    {0x00,0x00,0x0E,0x06,0x06,0x1E,0x36,0x66,0x66,0x66,0x66,0x3B,0x00,0x00,0x00,0x00},
    /* e */
    {0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x63,0x7E,0x60,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* f */
    {0x00,0x00,0x1C,0x36,0x32,0x30,0x7C,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00},
    /* g */
    {0x00,0x00,0x00,0x00,0x00,0x3B,0x66,0x66,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00,0x00},
    /* h */
    {0x00,0x00,0x70,0x30,0x30,0x36,0x3B,0x33,0x33,0x33,0x33,0x73,0x00,0x00,0x00,0x00},
    /* i */
    {0x00,0x00,0x0C,0x0C,0x00,0x1C,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    /* j */
    {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00,0x00},
    /* k */
    {0x00,0x00,0x70,0x30,0x30,0x33,0x33,0x36,0x3C,0x36,0x33,0x73,0x00,0x00,0x00,0x00},
    /* l */
    {0x00,0x00,0x1C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    /* m */
    {0x00,0x00,0x00,0x00,0x00,0x6E,0x7F,0x6B,0x6B,0x6B,0x6B,0x6B,0x00,0x00,0x00,0x00},
    /* n */
    {0x00,0x00,0x00,0x00,0x00,0x6E,0x33,0x33,0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00},
    /* o */
    {0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x63,0x63,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* p */
    {0x00,0x00,0x00,0x00,0x00,0x6E,0x33,0x33,0x33,0x33,0x3E,0x30,0x30,0x78,0x00,0x00},
    /* q */
    {0x00,0x00,0x00,0x00,0x00,0x3B,0x66,0x66,0x66,0x66,0x3E,0x06,0x06,0x0F,0x00,0x00},
    /* r */
    {0x00,0x00,0x00,0x00,0x00,0x6E,0x3B,0x33,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00},
    /* s */
    {0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x38,0x0E,0x03,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* t */
    {0x00,0x00,0x08,0x18,0x18,0x7E,0x18,0x18,0x18,0x18,0x1B,0x0E,0x00,0x00,0x00,0x00},
    /* u */
    {0x00,0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x66,0x3B,0x00,0x00,0x00,0x00},
    /* v */
    {0x00,0x00,0x00,0x00,0x00,0x63,0x63,0x63,0x63,0x36,0x1C,0x08,0x00,0x00,0x00,0x00},
    /* w */
    {0x00,0x00,0x00,0x00,0x00,0x63,0x63,0x6B,0x6B,0x6B,0x7F,0x36,0x00,0x00,0x00,0x00},
    /* x */
    {0x00,0x00,0x00,0x00,0x00,0x63,0x36,0x1C,0x1C,0x1C,0x36,0x63,0x00,0x00,0x00,0x00},
    /* y */
    {0x00,0x00,0x00,0x00,0x00,0x63,0x63,0x63,0x63,0x63,0x3F,0x03,0x06,0x3C,0x00,0x00},
    /* z */
    {0x00,0x00,0x00,0x00,0x00,0x7F,0x66,0x0C,0x18,0x30,0x63,0x7F,0x00,0x00,0x00,0x00},
    /* { */
    {0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
    /* | */
    {0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00},
    /* } */
    {0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
    /* ~ */
    {0x00,0x00,0x3B,0x6E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

/* ========== Drawing Functions ========== */

static inline void set_pixel(int x, int y, uint16_t color) {
    if (x >= 0 && x < LCD_W && y >= 0 && y < LCD_H) {
        framebuffer[y * LCD_W + x] = color;
    }
}

static void fill_rect(int x, int y, int w, int h, uint16_t color) {
    for (int j = y; j < y + h && j < LCD_H; j++) {
        for (int i = x; i < x + w && i < LCD_W; i++) {
            if (i >= 0 && j >= 0) {
                framebuffer[j * LCD_W + i] = color;
            }
        }
    }
}

static void draw_rounded_rect(int x, int y, int w, int h, int r, uint16_t color) {
    /* Fill main rectangles */
    fill_rect(x + r, y, w - 2*r, h, color);
    fill_rect(x, y + r, r, h - 2*r, color);
    fill_rect(x + w - r, y + r, r, h - 2*r, color);

    /* Draw corners */
    for (int cy = 0; cy < r; cy++) {
        for (int cx = 0; cx < r; cx++) {
            int dx = r - 1 - cx;
            int dy = r - 1 - cy;
            if (dx*dx + dy*dy <= r*r) {
                set_pixel(x + cx, y + cy, color);
                set_pixel(x + w - 1 - cx, y + cy, color);
                set_pixel(x + cx, y + h - 1 - cy, color);
                set_pixel(x + w - 1 - cx, y + h - 1 - cy, color);
            }
        }
    }
}

static void draw_char(int x, int y, char c, uint16_t color, int scale) {
    if (c < 0x20 || c > 0x7E) c = '?';
    int idx = c - 0x20;
    if (idx >= (int)(sizeof(font8x16)/sizeof(font8x16[0]))) return;

    for (int row = 0; row < 16; row++) {
        uint8_t bits = font8x16[idx][row];
        for (int col = 0; col < 8; col++) {
            if (bits & (0x80 >> col)) {
                for (int sy = 0; sy < scale; sy++) {
                    for (int sx = 0; sx < scale; sx++) {
                        set_pixel(x + col*scale + sx, y + row*scale + sy, color);
                    }
                }
            }
        }
    }
}

static void draw_string(int x, int y, const char *str, uint16_t color, int scale) {
    while (*str) {
        draw_char(x, y, *str, color, scale);
        x += 8 * scale;
        str++;
    }
}

static int string_width(const char *str, int scale) {
    return strlen(str) * 8 * scale;
}

static void draw_string_centered(int y, const char *str, uint16_t color, int scale) {
    int w = string_width(str, scale);
    int x = (LCD_W - w) / 2;
    draw_string(x, y, str, color, scale);
}

/* Progress bar with rounded ends */
static void draw_progress_bar(int x, int y, int w, int h, float pct, uint16_t bg_color, uint16_t fg_color) {
    int r = h / 2;

    /* Background */
    draw_rounded_rect(x, y, w, h, r, bg_color);

    /* Foreground */
    int fill_w = (int)((w - 4) * (pct / 100.0f));
    if (fill_w > 4) {
        draw_rounded_rect(x + 2, y + 2, fill_w, h - 4, r - 2, fg_color);
    }
}

/* Circular progress indicator */
static void draw_circle_progress(int cx, int cy, int radius, int thickness, float pct, uint16_t bg_color, uint16_t fg_color) {
    float angle_max = (pct / 100.0f) * 2.0f * M_PI;

    for (int y = -radius; y <= radius; y++) {
        for (int x = -radius; x <= radius; x++) {
            float dist = sqrtf(x*x + y*y);
            if (dist >= radius - thickness && dist <= radius) {
                float angle = atan2f(-x, -y) + M_PI; /* Start from top */
                uint16_t color = (angle <= angle_max) ? fg_color : bg_color;
                set_pixel(cx + x, cy + y, color);
            }
        }
    }
}

static void format_bytes_rate(float bytes_per_sec, char *buf, size_t len) {
    if (bytes_per_sec >= 1024.0f * 1024.0f * 1024.0f) {
        snprintf(buf, len, "%.1f GB/s", bytes_per_sec / (1024.0f * 1024.0f * 1024.0f));
    } else if (bytes_per_sec >= 1024.0f * 1024.0f) {
        snprintf(buf, len, "%.1f MB/s", bytes_per_sec / (1024.0f * 1024.0f));
    } else if (bytes_per_sec >= 1024.0f) {
        snprintf(buf, len, "%.1f KB/s", bytes_per_sec / 1024.0f);
    } else {
        snprintf(buf, len, "%.0f B/s", bytes_per_sec);
    }
}

void render_page_cpu(void) {
    fill_rect(0, 0, LCD_W, LCD_H, COLOR_BG);

    draw_string_centered(15, "CPU", COLOR_WHITE, 3);

    int cx = LCD_W / 2;
    int cy = 155;
    int radius = 85;
    draw_circle_progress(cx, cy, radius, 14, g_metrics.cpu_usage, COLOR_BG_GAUGE, COLOR_CYAN);

    char buf[32];
    snprintf(buf, sizeof(buf), "%.0f", g_metrics.cpu_usage);
    int w = string_width(buf, 5);
    draw_string(cx - w/2, cy - 30, buf, COLOR_WHITE, 5);
    draw_string(cx + w/2 + 4, cy - 10, "%", COLOR_GRAY, 2);

    if (g_metrics.cpu_temp > 0) {
        snprintf(buf, sizeof(buf), "%.0f", g_metrics.cpu_temp);
        uint16_t temp_color = (g_metrics.cpu_temp > 80) ? COLOR_RED :
                              (g_metrics.cpu_temp > 60) ? COLOR_ORANGE : COLOR_GREEN;
        int tw = string_width(buf, 4);
        int tx = (LCD_W - tw - 24) / 2;
        draw_string(tx, 268, buf, temp_color, 4);
        draw_string(tx + tw + 2, 268, "'C", COLOR_GRAY, 2);
    }
}

void render_page_memory(void) {
    fill_rect(0, 0, LCD_W, LCD_H, COLOR_BG);

    draw_string_centered(15, "RAM", COLOR_WHITE, 3);

    int cx = LCD_W / 2;
    int cy = 155;
    int radius = 85;
    uint16_t mem_color = (g_metrics.mem_pct > 90) ? COLOR_RED :
                         (g_metrics.mem_pct > 70) ? COLOR_ORANGE : COLOR_BLUE;
    draw_circle_progress(cx, cy, radius, 14, g_metrics.mem_pct, COLOR_BG_GAUGE, mem_color);

    char buf[32];
    snprintf(buf, sizeof(buf), "%.0f", g_metrics.mem_pct);
    int w = string_width(buf, 5);
    draw_string(cx - w/2, cy - 30, buf, COLOR_WHITE, 5);
    draw_string(cx + w/2 + 4, cy - 10, "%", COLOR_GRAY, 2);

    float used_gb = g_metrics.mem_used / (1024.0 * 1024.0 * 1024.0);
    float total_gb = g_metrics.mem_total / (1024.0 * 1024.0 * 1024.0);
    snprintf(buf, sizeof(buf), "%.1f/%.0f", used_gb, total_gb);
    int mw = string_width(buf, 3);
    int mx = (LCD_W - mw - 24) / 2;
    draw_string(mx, 268, buf, COLOR_GRAY, 3);
    draw_string(mx + mw + 2, 270, "GB", COLOR_DARK_GRAY, 2);
}

void render_page_network(void) {
    fill_rect(0, 0, LCD_W, LCD_H, COLOR_BG);

    draw_string_centered(15, "NET", COLOR_WHITE, 3);

    /* Interface name */
    draw_string_centered(60, g_metrics.net_iface, COLOR_TEAL, 2);

    /* RX card */
    draw_rounded_rect(10, 90, LCD_W - 20, 90, 8, COLOR_BG_CARD);
    draw_string(20, 98, "RX", COLOR_DARK_GRAY, 1);

    char buf[32];
    format_bytes_rate(g_metrics.net_rx_rate, buf, sizeof(buf));
    draw_string(20, 118, buf, COLOR_GREEN, 3);

    /* RX bar */
    float rx_pct = 0.0f;
    if (g_metrics.net_rx_rate > 0) {
        rx_pct = fminf(100.0f, g_metrics.net_rx_rate / (125000000.0f) * 100.0f); /* Scale to 1 Gbps */
    }
    draw_progress_bar(20, 160, LCD_W - 40, 10, rx_pct, COLOR_BG, COLOR_GREEN);

    /* TX card */
    draw_rounded_rect(10, 195, LCD_W - 20, 90, 8, COLOR_BG_CARD);
    draw_string(20, 203, "TX", COLOR_DARK_GRAY, 1);

    format_bytes_rate(g_metrics.net_tx_rate, buf, sizeof(buf));
    draw_string(20, 223, buf, COLOR_ORANGE, 3);

    /* TX bar */
    float tx_pct = 0.0f;
    if (g_metrics.net_tx_rate > 0) {
        tx_pct = fminf(100.0f, g_metrics.net_tx_rate / (125000000.0f) * 100.0f);
    }
    draw_progress_bar(20, 265, LCD_W - 40, 10, tx_pct, COLOR_BG, COLOR_ORANGE);
}

void render_page_system(void) {
    fill_rect(0, 0, LCD_W, LCD_H, COLOR_BG);

    draw_string_centered(20, g_metrics.hostname, COLOR_CYAN, 2);

    draw_rounded_rect(10, 60, LCD_W - 20, 70, 8, COLOR_BG_CARD);
    draw_string(20, 68, "UPTIME", COLOR_DARK_GRAY, 1);

    char buf[64];
    int days = g_metrics.uptime_secs / 86400;
    int hours = (g_metrics.uptime_secs % 86400) / 3600;
    if (days > 0) {
        snprintf(buf, sizeof(buf), "%dd %dh", days, hours);
    } else {
        int mins = (g_metrics.uptime_secs % 3600) / 60;
        snprintf(buf, sizeof(buf), "%dh %dm", hours, mins);
    }
    draw_string(20, 90, buf, COLOR_GREEN, 3);

    draw_rounded_rect(10, 145, LCD_W - 20, 70, 8, COLOR_BG_CARD);
    draw_string(20, 153, "LOAD", COLOR_DARK_GRAY, 1);
    snprintf(buf, sizeof(buf), "%.1f %.1f %.1f",
             g_metrics.load_1, g_metrics.load_5, g_metrics.load_15);
    draw_string(20, 175, buf, COLOR_WHITE, 3);

    time_t now = time(NULL);
    struct tm tm_buf;
    struct tm *tm = localtime_r(&now, &tm_buf);
    if (tm) {
        snprintf(buf, sizeof(buf), "%02d:%02d", tm->tm_hour, tm->tm_min);
        draw_string_centered(240, buf, COLOR_WHITE, 5);
        strftime(buf, sizeof(buf), "%d.%m.%Y", tm);
        draw_string_centered(300, buf, COLOR_DARK_GRAY, 1);
    }
}

void render_page_overview(void) {
    fill_rect(0, 0, LCD_W, LCD_H, COLOR_BG);

    draw_rounded_rect(10, 10, LCD_W - 20, 85, 8, COLOR_BG_CARD);
    draw_string(20, 18, "CPU", COLOR_DARK_GRAY, 1);
    char buf[32];
    snprintf(buf, sizeof(buf), "%.0f%%", g_metrics.cpu_usage);
    draw_string(20, 40, buf, COLOR_CYAN, 4);
    draw_progress_bar(20, 80, LCD_W - 40, 10, g_metrics.cpu_usage, COLOR_BG, COLOR_CYAN);

    draw_rounded_rect(10, 105, LCD_W - 20, 85, 8, COLOR_BG_CARD);
    draw_string(20, 113, "MEM", COLOR_DARK_GRAY, 1);
    snprintf(buf, sizeof(buf), "%.0f%%", g_metrics.mem_pct);
    draw_string(20, 135, buf, COLOR_BLUE, 4);
    draw_progress_bar(20, 175, LCD_W - 40, 10, g_metrics.mem_pct, COLOR_BG, COLOR_BLUE);

    draw_rounded_rect(10, 200, 107, 55, 6, COLOR_BG_CARD);
    draw_string(18, 208, "TEMP", COLOR_DARK_GRAY, 1);
    if (g_metrics.cpu_temp > 0) {
        snprintf(buf, sizeof(buf), "%.0fC", g_metrics.cpu_temp);
        uint16_t tc = (g_metrics.cpu_temp > 80) ? COLOR_RED : COLOR_ORANGE;
        draw_string(18, 228, buf, tc, 2);
    } else {
        draw_string(18, 228, "--", COLOR_GRAY, 2);
    }

    draw_rounded_rect(123, 200, 107, 55, 6, COLOR_BG_CARD);
    draw_string(131, 208, "LOAD", COLOR_DARK_GRAY, 1);
    snprintf(buf, sizeof(buf), "%.1f", g_metrics.load_1);
    draw_string(131, 228, buf, COLOR_GREEN, 2);

    time_t now = time(NULL);
    struct tm tm_buf;
    struct tm *tm = localtime_r(&now, &tm_buf);
    if (tm) {
        snprintf(buf, sizeof(buf), "%02d:%02d", tm->tm_hour, tm->tm_min);
        draw_string_centered(270, buf, COLOR_WHITE, 4);
    }
}

/* ========== Proxmox Page Renderers ========== */

void render_page_proxmox(void) {
    fill_rect(0, 0, LCD_W, LCD_H, COLOR_BG);

    draw_string_centered(10, "PROXMOX", COLOR_CYAN, 2);

    /* VM card */
    draw_rounded_rect(10, 50, LCD_W - 20, 90, 8, COLOR_BG_CARD);
    draw_string(20, 58, "VMs", COLOR_DARK_GRAY, 1);

    char buf[64];
    snprintf(buf, sizeof(buf), "%d", g_pve_metrics.running_vms);
    draw_string(20, 78, buf, COLOR_GREEN, 4);
    int num_w = string_width(buf, 4);
    snprintf(buf, sizeof(buf), "/ %d", g_pve_metrics.total_vms);
    draw_string(20 + num_w + 4, 88, buf, COLOR_GRAY, 2);

    /* CT card */
    draw_rounded_rect(10, 155, LCD_W - 20, 90, 8, COLOR_BG_CARD);
    draw_string(20, 163, "CTs", COLOR_DARK_GRAY, 1);

    snprintf(buf, sizeof(buf), "%d", g_pve_metrics.running_cts);
    draw_string(20, 183, buf, COLOR_GREEN, 4);
    num_w = string_width(buf, 4);
    snprintf(buf, sizeof(buf), "/ %d", g_pve_metrics.total_cts);
    draw_string(20 + num_w + 4, 193, buf, COLOR_GRAY, 2);

    /* Node name */
    draw_string_centered(265, g_pve_metrics.node_name, COLOR_GRAY, 2);

    /* PVE version at bottom */
    if (g_pve_metrics.pve_version[0] != '\0') {
        char ver[30];
        snprintf(ver, sizeof(ver), "%.29s", g_pve_metrics.pve_version);
        draw_string_centered(298, ver, COLOR_DARK_GRAY, 1);
    }
}

static void format_bytes_human(uint64_t bytes, char *buf, size_t len) {
    if (bytes >= (uint64_t)1024 * 1024 * 1024 * 1024) {
        snprintf(buf, len, "%.1fT", (double)bytes / (1024.0 * 1024.0 * 1024.0 * 1024.0));
    } else if (bytes >= (uint64_t)1024 * 1024 * 1024) {
        snprintf(buf, len, "%.1fG", (double)bytes / (1024.0 * 1024.0 * 1024.0));
    } else if (bytes >= (uint64_t)1024 * 1024) {
        snprintf(buf, len, "%.1fM", (double)bytes / (1024.0 * 1024.0));
    } else {
        snprintf(buf, len, "%" PRIu64 "B", bytes);
    }
}

void render_page_storage(void) {
    fill_rect(0, 0, LCD_W, LCD_H, COLOR_BG);

    draw_string_centered(10, "STORAGE", COLOR_WHITE, 2);

    int max_display = g_pve_metrics.storage_count;
    if (max_display > 4) max_display = 4;

    for (int i = 0; i < max_display; i++) {
        int y_base = 45 + i * 68;

        /* Pool name */
        draw_string(10, y_base, g_pve_metrics.storage[i].name, COLOR_CYAN, 1);

        /* Usage color based on percentage */
        uint16_t bar_color;
        float pct = g_pve_metrics.storage[i].used_pct;
        if (pct > 90.0f)
            bar_color = COLOR_RED;
        else if (pct >= 70.0f)
            bar_color = COLOR_ORANGE;
        else
            bar_color = COLOR_GREEN;

        /* Progress bar */
        draw_progress_bar(10, y_base + 18, LCD_W - 20, 12, pct, COLOR_BG_GAUGE, bar_color);

        /* Usage text */
        char used_str[16], total_str[16], pct_str[8];
        format_bytes_human(g_pve_metrics.storage[i].used_bytes, used_str, sizeof(used_str));
        format_bytes_human(g_pve_metrics.storage[i].total_bytes, total_str, sizeof(total_str));
        snprintf(pct_str, sizeof(pct_str), "%.0f%%", pct);

        char info[48];
        snprintf(info, sizeof(info), "%s / %s", used_str, total_str);
        draw_string(10, y_base + 36, info, COLOR_GRAY, 1);

        /* Percentage on the right */
        int pct_w = string_width(pct_str, 2);
        draw_string(LCD_W - 10 - pct_w, y_base + 32, pct_str, bar_color, 2);
    }

    if (max_display == 0) {
        draw_string_centered(140, "No storage", COLOR_DARK_GRAY, 2);
        draw_string_centered(170, "detected", COLOR_DARK_GRAY, 2);
    }
}
